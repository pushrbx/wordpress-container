name: WordPress Apache Image Mirror

on:
  # Run daily at 2 AM UTC to check for updates
  schedule:
    - cron: '0 2 * * *'

  # Allow manual triggering
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/wordpress-apache
  MIN_VERSION: "6.7.0"

jobs:
  check-and-build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Get WordPress apache tags from Docker Hub (6.7.0+)
      id: get-tags
      run: |
        echo "Fetching WordPress apache tags from Docker Hub..."

        # Function to compare versions
        version_compare() {
          local version1=$1
          local version2=$2

          # Use sort -V to compare versions properly
          if [ "$(printf '%s\n%s' "$version1" "$version2" | sort -V | head -n1)" = "$version1" ]; then
            if [ "$version1" = "$version2" ]; then
              return 0  # Equal
            else
              return 1  # version1 < version2
            fi
          else
            return 2    # version1 > version2
          fi
        }

        # Get all tags from Docker Hub API (fetch multiple pages if needed)
        ALL_TAGS=""
        PAGE=1
        while true; do
          TAGS_JSON=$(curl -s "https://hub.docker.com/v2/repositories/library/wordpress/tags/?page_size=100&page=$PAGE")
          PAGE_TAGS=$(echo "$TAGS_JSON" | jq -r '.results[]?.name // empty')

          if [ -z "$PAGE_TAGS" ]; then
            break
          fi

          ALL_TAGS="$ALL_TAGS$PAGE_TAGS"$'\n'
          PAGE=$((PAGE + 1))

          # Limit to reasonable number of pages to avoid infinite loop
          if [ $PAGE -gt 10 ]; then
            break
          fi
        done

        echo "Processing tags for apache variants >= ${{ env.MIN_VERSION }}..."

        # Filter for apache tags and version >= 6.7.0
        FILTERED_TAGS=""
        while IFS= read -r tag; do
          if [[ "$tag" == *"apache"* ]] && [[ "$tag" =~ ^[0-9]+\.[0-9]+\.[0-9]+ ]]; then
            # Extract version number (everything before the first hyphen)
            VERSION=$(echo "$tag" | sed 's/-.*$//')

            # Compare with minimum version
            version_compare "$VERSION" "${{ env.MIN_VERSION }}"
            RESULT=$?

            if [ $RESULT -eq 0 ] || [ $RESULT -eq 2 ]; then
              # Version is >= MIN_VERSION
              if [ -z "$FILTERED_TAGS" ]; then
                FILTERED_TAGS="$tag"
              else
                FILTERED_TAGS="$FILTERED_TAGS"$'\n'"$tag"
              fi
              echo "✓ Including tag: $tag (version: $VERSION)"
            else
              echo "✗ Skipping tag: $tag (version: $VERSION < ${{ env.MIN_VERSION }})"
            fi
          fi
        done <<< "$ALL_TAGS"

        echo "Final filtered apache tags (>= ${{ env.MIN_VERSION }}):"
        echo "$FILTERED_TAGS"

        # Convert to JSON array for matrix strategy
        if [ -n "$FILTERED_TAGS" ]; then
          TAGS_ARRAY=$(echo "$FILTERED_TAGS" | jq -R -s -c 'split("\n") | map(select(length > 0))')
        else
          TAGS_ARRAY="[]"
        fi
        echo "tags-matrix=$TAGS_ARRAY" >> $GITHUB_OUTPUT

        # Also set a simple list for other steps
        echo "apache-tags<<EOF" >> $GITHUB_OUTPUT
        echo "$FILTERED_TAGS" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Check existing tags in GHCR
      id: check-existing
      run: |
        echo "Checking existing tags in GHCR..."
        NEW_TAGS=""

        while IFS= read -r tag; do
          if [ -n "$tag" ]; then
            # Check if tag exists in GHCR
            if docker manifest inspect ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$tag >/dev/null 2>&1; then
              echo "Tag $tag already exists in GHCR"
            else
              echo "Tag $tag is new, will build"
              if [ -z "$NEW_TAGS" ]; then
                NEW_TAGS="$tag"
              else
                NEW_TAGS="$NEW_TAGS,$tag"
              fi
            fi
          fi
        done <<< "${{ steps.get-tags.outputs.apache-tags }}"

        echo "new-tags=$NEW_TAGS" >> $GITHUB_OUTPUT
        echo "New tags to build: $NEW_TAGS"

    - name: Build and push images
      if: steps.check-existing.outputs.new-tags != ''
      run: |
        IFS=',' read -ra TAGS_ARRAY <<< "${{ steps.check-existing.outputs.new-tags }}"

        for tag in "${TAGS_ARRAY[@]}"; do
          if [ -n "$tag" ]; then
            echo "Building image for tag: $tag"

            # Create temporary Dockerfile
            cat > Dockerfile.temp << EOF
        FROM wordpress:$tag
        WORKDIR /usr/src/wordpress
        RUN set -eux; \\
        	find /etc/apache2 -name '*.conf' -type f -exec sed -ri -e "s!/var/www/html!\$PWD!g" -e "s!Directory /var/www/!Directory \$PWD!g" '{}' +; \\
        	cp -s wp-config-docker.php wp-config.php
        EOF

            # Build and push the image
            docker buildx build \
              --platform linux/amd64,linux/arm64 \
              --file Dockerfile.temp \
              --tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$tag \
              --push \
              .

            # Clean up
            rm Dockerfile.temp

            echo "Successfully built and pushed ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$tag"
          fi
        done

    - name: Update latest tag
      if: steps.check-existing.outputs.new-tags != ''
      run: |
        # Get the most recent apache tag (using proper version sorting)
        LATEST_TAG=$(echo "${{ steps.get-tags.outputs.apache-tags }}" | grep -E '^[0-9]+\.[0-9]+\.[0-9]+-.*apache' | sort -V | tail -1)

        if [ -n "$LATEST_TAG" ]; then
          echo "Tagging $LATEST_TAG as latest"

          # Pull the image we just built
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$LATEST_TAG

          # Tag as latest
          docker tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$LATEST_TAG ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

          # Push latest tag
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
        fi

    - name: Summary
      run: |
        echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Registry**: ${{ env.REGISTRY }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Image**: ${{ env.IMAGE_NAME }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Minimum Version**: ${{ env.MIN_VERSION }}" >> $GITHUB_STEP_SUMMARY

        if [ -n "${{ steps.check-existing.outputs.new-tags }}" ]; then
          echo "- **New tags built**: ${{ steps.check-existing.outputs.new-tags }}" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **Result**: No new tags to build" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "All available tags (>= ${{ env.MIN_VERSION }}):" >> $GITHUB_STEP_SUMMARY
        echo '```&#x27; &gt;&gt; $GITHUB_STEP_SUMMARY
        echo &quot;${{ steps.get-tags.outputs.apache-tags }}&quot; &gt;&gt; $GITHUB_STEP_SUMMARY
        echo &#x27;```' >> $GITHUB_STEP_SUMMARY
