name: WordPress Apache Image Mirror

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/wordpress-apache
  MIN_VERSION: "6.7.0"

jobs:
  check-and-build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Get WordPress apache tags from Docker Hub (6.7.0+)
      id: get-tags
      run: |
        set -euo pipefail

        echo "Fetching WordPress apache tags from Docker Hub..."

        # Function to compare versions using sort -V
        version_gte() {
          local version1="$1"
          local version2="$2"

          if [ "$(printf '%s\n%s' "$version2" "$version1" | sort -V | head -n1)" = "$version2" ]; then
            return 0
          else
            return 1
          fi
        }

        # Get tags from Docker Hub API
        echo "Fetching tags from Docker Hub API..."
        TAGS_JSON=$(curl -s "https://hub.docker.com/v2/repositories/library/wordpress/tags/?page_size=100" || echo '{"results":[]}')

        # Extract all tag names
        ALL_TAGS=$(echo "$TAGS_JSON" | jq -r '.results[]?.name // empty' 2>/dev/null || echo "")

        if [ -z "$ALL_TAGS" ]; then
          echo "Warning: No tags found from API"
          echo "apache-tags=" >> $GITHUB_OUTPUT
          echo "tags-matrix=[]" >> $GITHUB_OUTPUT
          exit 0
        fi

        echo "Total tags found: $(echo "$ALL_TAGS" | wc -l)"

        # Filter for apache tags and version >= 6.7.0
        echo "Filtering for apache tags >= ${{ env.MIN_VERSION }}..."
        FILTERED_TAGS=""

        while IFS= read -r tag; do
          [ -z "$tag" ] && continue

          if [[ "$tag" == *"apache"* ]]; then
            echo "Processing apache tag: $tag"

            VERSION=""
            if [[ "$tag" =~ ^([0-9]+\.[0-9]+\.[0-9]+) ]]; then
              VERSION="${BASH_REMATCH[1]}"
            elif [[ "$tag" =~ ^([0-9]+\.[0-9]+) ]]; then
              VERSION="${BASH_REMATCH[1]}.0"
            fi

            if [ -n "$VERSION" ]; then
              echo "  Extracted version: $VERSION"

              if version_gte "$VERSION" "${{ env.MIN_VERSION }}"; then
                echo "  ✓ Including tag: $tag"
                if [ -z "$FILTERED_TAGS" ]; then
                  FILTERED_TAGS="$tag"
                else
                  FILTERED_TAGS="$FILTERED_TAGS"$'\n'"$tag"
                fi
              else
                echo "  ✗ Skipping tag: $tag (< ${{ env.MIN_VERSION }})"
              fi
            else
              echo "  ? Could not extract version from: $tag"
            fi
          fi
        done <<< "$ALL_TAGS"

        echo "Final filtered apache tags:"
        echo "$FILTERED_TAGS"

        # Convert to JSON array
        if [ -n "$FILTERED_TAGS" ]; then
          TAGS_ARRAY=$(echo "$FILTERED_TAGS" | jq -R -s -c 'split("\n") | map(select(length > 0))' 2>/dev/null || echo '[]')
        else
          TAGS_ARRAY="[]"
        fi

        echo "tags-matrix=$TAGS_ARRAY" >> $GITHUB_OUTPUT

        {
          echo "apache-tags<<EOF"
          echo "$FILTERED_TAGS"
          echo "EOF"
        } >> $GITHUB_OUTPUT

    - name: Check existing tags in GHCR
      id: check-existing
      if: steps.get-tags.outputs.apache-tags != ''
      run: |
        set -euo pipefail

        echo "Checking existing tags in GHCR..."
        NEW_TAGS=""

        while IFS= read -r tag; do
          if [ -n "$tag" ]; then
            if docker manifest inspect ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$tag >/dev/null 2>&1; then
              echo "Tag $tag already exists in GHCR"
            else
              echo "Tag $tag is new, will build"
              if [ -z "$NEW_TAGS" ]; then
                NEW_TAGS="$tag"
              else
                NEW_TAGS="$NEW_TAGS,$tag"
              fi
            fi
          fi
        done <<< "${{ steps.get-tags.outputs.apache-tags }}"

        echo "new-tags=$NEW_TAGS" >> $GITHUB_OUTPUT
        echo "New tags to build: $NEW_TAGS"

    - name: Build and push images
      if: steps.check-existing.outputs.new-tags != ''
      run: |
        set -euo pipefail

        IFS=',' read -ra TAGS_ARRAY <<< "${{ steps.check-existing.outputs.new-tags }}"

        for tag in "${TAGS_ARRAY[@]}"; do
          if [ -n "$tag" ]; then
            echo "Building image for tag: $tag"

            # Create Dockerfile from template
            sed "s/{{TAG}}/$tag/g" Dockerfile.template > Dockerfile.build

            echo "Generated Dockerfile:"
            cat Dockerfile.build

            # Build and push the image
            docker buildx build \
              --platform linux/amd64,linux/arm64 \
              --file Dockerfile.build \
              --tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$tag \
              --push \
              .

            # Clean up
            rm Dockerfile.build

            echo "Successfully built and pushed ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$tag"
          fi
        done

    - name: Update latest tag
      if: steps.check-existing.outputs.new-tags != ''
      run: |
        set -euo pipefail

        LATEST_TAG=$(echo "${{ steps.get-tags.outputs.apache-tags }}" | grep -E '^[0-9]+\.[0-9]+(\.[0-9]+)?.*apache' | sort -V | tail -1 || echo "")

        if [ -n "$LATEST_TAG" ]; then
          echo "Tagging $LATEST_TAG as latest"

          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$LATEST_TAG
          docker tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$LATEST_TAG ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
        else
          echo "No suitable tag found for latest"
        fi

    - name: Summary
      run: |
        echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Registry**: ${{ env.REGISTRY }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Image**: ${{ env.IMAGE_NAME }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Minimum Version**: ${{ env.MIN_VERSION }}" >> $GITHUB_STEP_SUMMARY

        NEW_TAGS="${{ steps.check-existing.outputs.new-tags || '' }}"
        if [ -n "$NEW_TAGS" ]; then
          echo "- **New tags built**: $NEW_TAGS" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **Result**: No new tags to build" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "All available tags (>= ${{ env.MIN_VERSION }}):" >> $GITHUB_STEP_SUMMARY
        echo '```&#x27; &gt;&gt; $GITHUB_STEP_SUMMARY
        echo &quot;${{ steps.get-tags.outputs.apache-tags }}&quot; &gt;&gt; $GITHUB_STEP_SUMMARY
        echo &#x27;```' >> $GITHUB_STEP_SUMMARY
